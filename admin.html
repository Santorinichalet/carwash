<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„Ù…Ø¹Ø© â€” Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª</title>
  <style>
    :root{
      --bg1:#e6f7ff; --bg2:#f0fffb; --ink:#0f1a2b;
      --card:#ffffff; --line:#e6eef8;
      --red:#ef4444; --green:#00d2a0; --blue:#00aaff;
      --muted:#5f7aa3;
    }
    *{box-sizing:border-box}
    body{
      font-family:Tajawal,system-ui,Arial;
      background: radial-gradient(1200px 700px at 80% -10%, var(--bg1), transparent 60%), linear-gradient(180deg, var(--bg1), var(--bg2));
      color:var(--ink); margin:0
    }
    header{
      display:flex; align-items:center; gap:12px; padding:10px 14px;
      background:linear-gradient(135deg, rgba(0,170,255,.12), rgba(0,210,160,.10)), #ffffffaa;
      border-bottom:1px solid var(--line);
      backdrop-filter:saturate(1.2) blur(2px);
    }
    header img{width:44px;height:44px;border-radius:10px;box-shadow:0 3px 10px rgba(0,0,0,.06)}
    header h3{margin:0;font-size:1.1rem}
    header small{color:var(--muted)}
    .wrap{max-width:980px;margin:12px auto 96px;padding:0 12px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:10px 0;box-shadow:0 8px 22px rgba(0,0,0,.05)}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:#eaf4ff;color:#0b4a7a;font-size:12px;border:1px solid var(--line)}
    button{border:none;border-radius:12px;padding:10px 14px;cursor:pointer;font-weight:800}
    button.red{background:var(--red);color:#fff}
    button.green{background:var(--green);color:#003326}
    button.blue{background:var(--blue);color:#fff}
    button:disabled{opacity:.9;filter:saturate(.8);cursor:not-allowed}
    small{opacity:.85;color:var(--muted)}
    .empty{opacity:.8;text-align:center;padding:16px}
    .tools{display:flex;gap:8px;flex-wrap:wrap;margin-top:10px}
    .report-fab-wrap{position:fixed;left:0;right:0;bottom:14px;display:flex;justify-content:center;z-index:9999;pointer-events:none}
    .report-fab{pointer-events:auto;background:var(--blue);color:#fff;border:none;border-radius:999px;padding:12px 18px;font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.18)}
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.55);display:none;align-items:center;justify-content:center;z-index:10000}
    .modal{width:min(96vw,920px);background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;box-shadow:0 16px 40px rgba(0,0,0,.18)}
    .modal-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
    .modal-head h3{margin:0}
    .controls{display:flex;gap:10px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
    select{background:#f8fbff;color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 10px}
    .grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
    .tile{background:#f8fbff;border:1px solid var(--line);border-radius:12px;padding:12px}
    .tile b{display:block;font-size:14px;opacity:.9}
    .tile span{display:block;font-size:20px;margin-top:6px}
  </style>
</head>
<body>
<header>
  <img src="https://i.ibb.co/k2wtWBrW/unnamed.jpg" alt="Ø´Ø¹Ø§Ø± Ù„Ù…Ø¹Ø©">
  <div>
    <h3>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ù„Ù…Ø¹Ø©</h3>
    <small id="permNote">ğŸ”” ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</small>
  </div>
</header>

<div class="wrap" id="list"></div>

<div class="report-fab-wrap">
  <button class="report-fab" id="openReportBtn">ğŸ“Š ØªÙ‚Ø±ÙŠØ±</button>
</div>

<div class="modal-backdrop" id="reportModal">
  <div class="modal">
    <div class="modal-head">
      <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
      <button class="red" id="closeReportBtn">Ø¥ØºÙ„Ø§Ù‚ âœ–</button>
    </div>
    <div class="controls">
      <label>Ø§Ù„Ù†Ø·Ø§Ù‚ Ø§Ù„Ø²Ù…Ù†ÙŠ:</label>
      <select id="range">
        <option value="today">Ø§Ù„ÙŠÙˆÙ…</option>
        <option value="week">Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</option>
        <option value="month">Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±</option>
        <option value="all" selected>Ø§Ù„ÙƒÙ„</option>
      </select>
      <button class="blue" id="runReportBtn">Ø¹Ø±Ø¶ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</button>
    </div>
    <div id="reportResult" class="grid"></div>
  </div>
</div>

<audio id="ding" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  // Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyC_kRUAmKIFQwWK0Xrr8PeebnQbWGauu34",
    authDomain: "wash-a7ef9.firebaseapp.com",
    projectId: "wash-a7ef9",
    storageBucket: "wash-a7ef9.firebasestorage.app",
    messagingSenderId: "244309029995",
    appId: "1:244309029995:web:b5cb0534edce26aac3ed2e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
  if ('Notification' in window) {
    Notification.requestPermission().then(p=>{
      document.getElementById('permNote').textContent =
        (p==='granted' ? 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© âœ…' : 'ğŸ”” ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ù…ØªØµÙØ­Ùƒ');
    });
  }

  const list = document.getElementById('list');
  const ding = document.getElementById('ding');

  // Ø­Ø§Ù„Ø© Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  const live = new Map(); // id -> data
  function renderFromLive(){
    const arr = Array.from(live.values())
      .sort((a,b)=>(a.createdAt||'').localeCompare(b.createdAt||'')); // Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹
    render(arr);
  }

  // âœ… ÙØ­Øµ Ø³Ø±ÙŠØ¹ Ù„ØµÙ„Ø§Ø­ÙŠØ§Øª Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© (Ù„Ùˆ Ø§Ù„Ù‚ÙˆØ§Ø¹Ø¯ ØªÙ…Ù†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© ÙŠØ¸Ù‡Ø± ØªÙ†Ø¨ÙŠÙ‡)
  db.collection('bookings').limit(1).get()
    .then(()=>console.log('[admin] read test OK'))
    .catch(err=>{
      console.error('[admin] read test failed:', err);
      list.innerHTML = `
        <div class="card" style="border-color:#ffb4b4">
          ØªØ¹Ø°Ø± Ù‚Ø±Ø§Ø¡Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ù…Ù† Firestore (Ù‚Ø¯ ØªÙƒÙˆÙ† Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø­Ù…Ø§ÙŠØ© ØªÙ…Ù†Ø¹ Ø§Ù„Ù‚Ø±Ø§Ø¡Ø©).<br>
          <small>Ø§ÙØªØ­ Console Ù„Ù„Ø§Ø·Ù„Ø§Ø¹ Ø¹Ù„Ù‰ Ø§Ù„ØªÙØ§ØµÙŠÙ„.</small>
        </div>`;
    });

  // âœ… Ù…Ø³ØªÙ…Ø¹ ÙˆØ§Ø­Ø¯ Ù„Ù„Ø­Ø§Ù„ØªÙŠÙ† pending + accepted (Ø¨Ø¯Ù„ Ù…Ø³ØªÙ…Ø¹ÙŠÙ† Ù…Ù†ÙØµÙ„ÙŠÙ†)
  db.collection('bookings')
    .where('status', 'in', ['pending','accepted'])
    .onSnapshot(
      snap=>{
        snap.docChanges().forEach(ch=>{
          const id = ch.doc.id;
          const data = { id, ...ch.doc.data() };

          if (ch.type === 'added' || ch.type === 'modified') {
            live.set(id, data);

            // Ø¬Ø±Ø³ Ø¹Ù†Ø¯ Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù†ØªØ¸Ø§Ø±
            if (ch.type==='added' && data.status==='pending'){
              try{ ding.currentTime=0; ding.play(); }catch(e){}
              if (Notification.permission==='granted'){
                new Notification('Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ ğŸš—',{ body:'ÙˆØ§Ø±Ø¯ Ø¬Ø¯ÙŠØ¯ ÙÙŠ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±', silent:false });
              }
            }
          } else if (ch.type === 'removed') {
            live.delete(id);
          }
        });
        renderFromLive();
      },
      err=>{
        console.error('[admin] onSnapshot error:', err);
        list.innerHTML = `
          <div class="card" style="border-color:#ffb4b4">
            ØªØ¹Ø°Ø± Ø§Ù„Ø§Ø´ØªØ±Ø§Ùƒ ÙÙŠ Ø§Ù„ØªØ­Ø¯ÙŠØ«Ø§Øª Ø§Ù„Ù„Ø­Ø¸ÙŠØ©: ${err.message || err}
          </div>`;
      }
    );

  // Ø£Ø¯ÙˆØ§Øª Ø§Ù„Ø¹Ø±Ø¶
  function currency(n){ return (+(n||0)).toFixed(2) + ' Ø±.Ø¹'; }
  function statusLabel(s){
    return s==='pending'  ? 'Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±' :
           s==='accepted' ? 'Ù…Ø³ØªÙ„Ù…Ø©' :
           s==='completed'? 'ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°' :
           s==='rejected' ? 'Ù…Ø±ÙÙˆØ¶Ø©' : s;
  }

  function render(items){
    list.innerHTML = '';
    if (!items.length){
      list.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª (Ø§Ù†ØªØ¸Ø§Ø±/Ù…Ø³ØªÙ„Ù…Ø©).</div>';
      return;
    }
    items.forEach(x=>{
      const el = document.createElement('div');
      el.className = 'card';
      const accepted = x.status === 'accepted';

      el.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${x.phone || 'â€”'}</div>
          <div class="pill">Ø§Ù„Ø­Ø§Ù„Ø©: ${statusLabel(x.status)}</div>
        </div>
        <div class="row">
          <div><b>Ù†ÙˆØ¹ Ø§Ù„Ø³ÙŠØ§Ø±Ø©:</b> ${x.carType || 'â€”'}</div>
          <div><b>Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„:</b> ${x.package==='both'?'Ø®Ø§Ø±Ø¬ÙŠ ÙˆØ¯Ø§Ø®Ù„ÙŠ': (x.package==='external'?'Ø®Ø§Ø±Ø¬ÙŠ':'â€”')}</div>
          <div><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${currency(x.price)}</div>
        </div>
        <div class="row"><b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ${x.address || 'â€”'}</div>
        <small>ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${x.createdAt || 'â€”'}</small>
        <div class="tools">
          <button class="${accepted?'green':'blue'}"
                  id="assign-${x.id}"
                  ${accepted?'disabled':''}
                  onclick="markAccepted('${x.id}', this)">${accepted?'ğŸšš Ù…Ø³ØªÙ„Ù…Ø©':'Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©'}</button>

          <button class="green" id="done-${x.id}"   onclick="markCompleted('${x.id}', this)">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° âœ”</button>
          <button class="red"   id="reject-${x.id}" onclick="markRejected('${x.id}', this)">Ø±ÙØ¶ Ø§Ù„Ù…Ù‡Ù…Ø© âœ–</button>
          <button class="blue"  onclick="openMap(${x.lat||'null'}, ${x.lng||'null'})">Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
        </div>
      `;
      list.appendChild(el);
    });
  }

  function openMap(lat, lng){
    if (!lat || !lng) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª'); return; }
    window.open(`https://www.google.com/maps?q=${lat},${lng}`,'_blank');
  }

  // Ø£Ø²Ø±Ø§Ø± Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ø­Ø§Ù„Ø§Øª
  async function markAccepted(id, btn){
    if (btn && btn.classList.contains('green')) return;
    await db.collection('bookings').doc(id).update({
      status:'accepted', acceptedAt:new Date().toISOString()
    });
    if (btn){
      btn.classList.remove('blue');
      btn.classList.add('green');
      btn.textContent = 'ğŸšš Ù…Ø³ØªÙ„Ù…Ø©';
      btn.disabled = true;
    }
  }

  async function markRejected(id, btn){
    await db.collection('bookings').doc(id).update({
      status:'rejected', rejectedAt:new Date().toISOString()
    });
    const card = btn.closest('.card'); if (card) card.remove();
    live.delete(id); renderFromLive();
  }

  async function markCompleted(id, btn){
    await db.collection('bookings').doc(id).update({
      status:'completed', completedAt:new Date().toISOString()
    });
    const card = btn.closest('.card'); if (card) card.remove();
    live.delete(id); renderFromLive();
  }

  // Ø§Ù„ØªÙ‚Ø±ÙŠØ±
  const modal = document.getElementById('reportModal');
  const openBtn = document.getElementById('openReportBtn');
  const closeBtn = document.getElementById('closeReportBtn');
  const runBtn = document.getElementById('runReportBtn');
  const rangeSel = document.getElementById('range');
  const out = document.getElementById('reportResult');

  openBtn.addEventListener('click', ()=>{ modal.style.display='flex'; out.innerHTML=''; });
  closeBtn.addEventListener('click', ()=> modal.style.display='none');
  modal.addEventListener('click', e=>{ if(e.target===modal) modal.style.display='none'; });

  runBtn.addEventListener('click', async ()=>{
    out.innerHTML = '<div class="tile"><b>Ø¬Ø§Ø± Ø§Ù„ØªØ­Ù…ÙŠÙ„â€¦</b></div>';
    try{
      const snap = await db.collection('bookings').get();
      const all = snap.docs.map(d=>({ id:d.id, ...d.data() }));
      const filtered = filterByRange(all, rangeSel.value);

      const sum = (arr, key)=> arr.reduce((a,x)=> a + (+x[key]||0), 0);
      const byStatus = s => filtered.filter(x=> x.status===s);
      const totalPrice = sum(filtered, 'price');

      const stats = {
        totalCount   : filtered.length,
        totalPrice   : totalPrice,
        pendingCount : byStatus('pending').length,
        acceptedCount: byStatus('accepted').length,
        completedCount: byStatus('completed').length,
        rejectedCount: byStatus('rejected').length,
        pendingPrice : sum(byStatus('pending'), 'price'),
        acceptedPrice: sum(byStatus('accepted'), 'price'),
        completedPrice: sum(byStatus('completed'), 'price'),
        rejectedPrice: sum(byStatus('rejected'), 'price'),
      };
      renderReport(stats);
    }catch(e){
      console.error(e);
      out.innerHTML = '<div class="tile">ÙØ´Ù„ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„ØªÙ‚Ø±ÙŠØ±</div>';
    }
  });

  function renderReport(s){
    const currency = n => (+(n||0)).toFixed(2)+' Ø±.Ø¹';
    out.innerHTML = `
      <div class="tile"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</b><span>${s.totalCount}</span></div>
      <div class="tile"><b>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø³Ø¹Ø±</b><span>${currency(s.totalPrice)}</span></div>
      <div class="tile"><b>Ù‚ÙŠØ¯ Ø§Ù„Ø§Ù†ØªØ¸Ø§Ø±</b><span>${s.pendingCount} | ${currency(s.pendingPrice)}</span></div>
      <div class="tile"><b>ØªÙ… Ø§Ù„Ø§Ø³ØªÙ„Ø§Ù…</b><span>${s.acceptedCount} | ${currency(s.acceptedPrice)}</span></div>
      <div class="tile"><b>ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ°</b><span>${s.completedCount} | ${currency(s.completedPrice)}</span></div>
      <div class="tile"><b>Ù…Ø±ÙÙˆØ¶Ø©</b><span>${s.rejectedCount} | ${currency(s.rejectedPrice)}</span></div>
    `;
  }

  function filterByRange(items, range){
    if (range==='all') return items;
    const now = new Date();
    let start = new Date(0);
    if (range==='today'){
      start = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    } else if (range==='week'){
      const day = now.getDay() || 7;
      start = new Date(now.getFullYear(), now.getMonth(), now.getDate() - (day-1));
    } else if (range==='month'){
      start = new Date(now.getFullYear(), now.getMonth(), 1);
    }
    return items.filter(x=>{
      const t = x.createdAt ? Date.parse(x.createdAt) : 0;
      return t >= +start && t <= +now;
    });
  }
</script>
</body>
</html>
