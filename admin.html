<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Ù„ÙˆØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª â€” Ù„Ù…Ø¹Ø©</title>
  <style>
    body{font-family:Tajawal,system-ui,Arial;background:#0b1020;color:#fff;margin:0}
    header{display:flex;justify-content:space-between;align-items:center;padding:12px 16px;background:#111a36;border-bottom:1px solid #223}
    .wrap{max-width:900px;margin:12px auto;padding:0 12px}
    .card{background:#121833;border:1px solid #243055;border-radius:12px;padding:14px;margin:10px 0}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .pill{padding:4px 10px;border-radius:999px;background:#2b3563;font-size:12px}
    button{background:#22c55e;color:#021;border:none;border-radius:10px;padding:8px 12px;cursor:pointer;font-weight:700}
    button.secondary{background:#1e81b0;color:#001}
    small{opacity:.85}
    .alert{padding:12px;background:#351f2b;border:1px solid #6a2f4b;border-radius:10px}
    .empty{opacity:.8;text-align:center;padding:16px}
  </style>
</head>
<body>
<header>
  <h3>Ø§Ù„Ø·Ù„Ø¨Ø§Øª Ø§Ù„ÙˆØ§Ø±Ø¯Ø© (Ù…Ø¨Ø§Ø´Ø±)</h3>
  <div><small id="permNote">ğŸ”” ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</small></div>
</header>

<div class="wrap" id="list"></div>

<audio id="ding" src="https://actions.google.com/sounds/v1/alarms/beep_short.ogg" preload="auto"></audio>

<!-- Firebase compat -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
<script>
  // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ù…Ø´Ø±ÙˆØ¹Ùƒ
  const firebaseConfig = {
    apiKey: "AIzaSyC_kRUAmKIFQwWK0Xrr8PeebnQbWGauu34",
    authDomain: "wash-a7ef9.firebaseapp.com",
    projectId: "wash-a7ef9",
    storageBucket: "wash-a7ef9.firebasestorage.app",
    messagingSenderId: "244309029995",
    appId: "1:244309029995:web:b5cb0534edce26aac3ed2e"
  };
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // Ø·Ù„Ø¨ ØµÙ„Ø§Ø­ÙŠØ© Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø³Ø·Ø­ Ø§Ù„Ù…ÙƒØªØ¨
  if ('Notification' in window) {
    Notification.requestPermission().then(p=>{
      document.getElementById('permNote').textContent =
        (p==='granted' ? 'Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…ÙØ¹Ù„Ø© âœ…' : 'ğŸ”” ÙØ¹Ù‘Ù„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ù…Ù† Ù…ØªØµÙØ­Ùƒ');
    });
  }

  const list = document.getElementById('list');
  const ding = document.getElementById('ding');
  const seen = new Set();

  function render(items){
    list.innerHTML = '';
    if (!items.length){
      list.innerHTML = '<div class="empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø·Ù„Ø¨Ø§Øª Ø­Ø§Ù„ÙŠØ§Ù‹.</div>';
      return;
    }
    items.forEach(x=>{
      const el = document.createElement('div');
      el.className='card';
      el.innerHTML = `
        <div class="row" style="justify-content:space-between;">
          <div><b>Ø§Ù„Ù‡Ø§ØªÙ:</b> ${x.phone || 'â€”'}</div>
          <div class="pill">Ø§Ù„Ø­Ø§Ù„Ø©: ${x.status}</div>
        </div>
        <div class="row">
          <div><b>Ù†ÙˆØ¹ Ø§Ù„ØºØ³ÙŠÙ„:</b> ${x.package==='both'?'Ø®Ø§Ø±Ø¬ÙŠ ÙˆØ¯Ø§Ø®Ù„ÙŠ': (x.package==='external'?'Ø®Ø§Ø±Ø¬ÙŠ':'â€”')}</div>
          <div><b>Ø§Ù„Ø³Ø¹Ø±:</b> ${(+(x.price||0)).toFixed(2)} Ø±.Ø¹</div>
        </div>
        <div class="row"><b>Ø§Ù„Ù…ÙˆÙ‚Ø¹:</b> ${x.address || 'â€”'}</div>
        <small>ÙˆÙ‚Øª Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡: ${x.createdAt || 'â€”'}</small>
        <div class="row" style="margin-top:8px">
          <button class="secondary" onclick="openMap(${x.lat||'null'}, ${x.lng||'null'})">Ø¹Ø±Ø¶ Ø§Ù„Ø®Ø±ÙŠØ·Ø©</button>
          <button onclick="markAssigned('${x.id}')">Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©</button>
          <button onclick="markDone('${x.id}')">ØªÙ… Ø§Ù„ØªÙ†ÙÙŠØ° âœ”</button>
        </div>
      `;
      list.appendChild(el);
    });
  }

  function handleErr(err){
    console.error(err);
    list.innerHTML = '<div class="alert">âš ï¸ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„: '+(err.message||'')+'</div>';
  }

  // Ø§Ù„Ø§Ø³ØªÙ…Ø§Ø¹ Ø§Ù„ÙÙˆØ±ÙŠ Ù„Ù„Ø·Ù„Ø¨Ø§Øª pending â€” Ø¨Ø¯ÙˆÙ† orderBy Ù„ØªÙØ§Ø¯ÙŠ Ø§Ù„ÙÙ‡Ø±Ø³
  db.collection('bookings')
    .where('status','==','pending')
    .onSnapshot(snap=>{
      // ØªÙ†Ø¨ÙŠÙ‡ Ø¹Ù„Ù‰ Ø§Ù„Ø¥Ø¶Ø§ÙØ§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙÙ‚Ø· Ø¨Ø¹Ø¯ Ø£ÙˆÙ„ Ø¯ÙØ¹Ø©
      snap.docChanges().forEach(ch=>{
        if (ch.type==='added'){
          if (seen.size>0) {
            try { ding.currentTime=0; ding.play(); } catch(e){}
            if (Notification.permission==='granted'){
              new Notification('Ø·Ù„Ø¨ ØºØ³ÙŠÙ„ Ø¬Ø¯ÙŠØ¯ ğŸš—', { body: 'Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨Ø§Ù†ØªØ¸Ø§Ø± Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©', silent:false });
            }
          }
          seen.add(ch.doc.id);
        }
      });

      // ØªØ±ØªÙŠØ¨ Ù…Ø­Ù„ÙŠ Ø­Ø³Ø¨ createdAt (Ù†Øµ ISO)
      const items = snap.docs.map(d => ({ id: d.id, ...d.data() }))
                             .sort((a,b)=> (b.createdAt||'').localeCompare(a.createdAt||''));
      render(items);
    }, handleErr);

  function openMap(lat, lng){
    if (!lat || !lng) { alert('Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª'); return; }
    window.open(`https://www.google.com/maps?q=${lat},${lng}`,'_blank');
  }

  async function markAssigned(id){
    await db.collection('bookings').doc(id).update({ status:'assigned', assignedAt:new Date().toISOString() });
    alert('ØªÙ… Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ù…Ù‡Ù…Ø©');
  }

  async function markDone(id){
    await db.collection('bookings').doc(id).update({ status:'done', doneAt:new Date().toISOString() });
    alert('ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© âœ”ï¸');
  }
</script>
</body>
</html>
